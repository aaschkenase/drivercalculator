<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
    <title>Tag Driver Pro | Route Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { 
            --bg: #0b0f1a; --card: #161e2e; --border: #2d3748;
            --accent: #38bdf8; --text: #f1f5f9; --muted: #94a3b8;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 80px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 15px; }
        
        /* Navigation */
        nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 12px; overflow-x: auto; }
        .nav-btn { padding: 12px 24px; border-radius: 10px; border: none; background: transparent; color: var(--muted); cursor: pointer; font-weight: 700; white-space: nowrap; transition: 0.2s; }
        .nav-btn.active { background: var(--accent); color: var(--bg); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Top Stats */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .summary-box { background: #1e293b; border: 1px solid var(--border); padding: 15px 20px; border-radius: 16px; position: relative; }
        .summary-box::after { content:""; position:absolute; left:0; top:10%; height:80%; width:4px; background:var(--accent); border-radius:0 4px 4px 0; }
        .label { font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: 800; display: block; margin-bottom: 4px; }
        .value { font-size: 24px; font-weight: 900; }

        /* Inputs */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; margin-bottom: 20px; }
        .card-header { padding: 15px 20px; border-bottom: 1px solid var(--border); font-weight: 800; font-size: 11px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        .card-body { padding: 20px; }

        .input-row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
        .input-group { flex: 1; min-width: 180px; }
        label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 6px; color: var(--muted); }
        input { background: #0f172a; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 10px; font-weight: 600; width: 100%; font-size: 14px; }
        input:focus { border-color: var(--accent); outline: none; }

        /* Map Layout */
        .map-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: 600px; }
        #map { width: 100%; height: 100%; border-radius: 16px; border: 1px solid var(--border); z-index: 1; }
        .sidebar { overflow-y: auto; padding-right: 5px; }
        .trip-card { background: #1e293b; border: 1px solid var(--border); padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .trip-card:hover { border-color: var(--accent); background: #263245; }
        .trip-route { font-weight: 800; font-size: 13px; color: var(--text); margin-bottom: 5px; }
        .trip-meta { font-size: 12px; color: var(--muted); display: flex; justify-content: space-between; }
        
        @media (max-width: 900px) { .map-layout { grid-template-columns: 1fr; height: auto; } #map { height: 400px; } }

        /* Utilities */
        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: var(--bg); width: 100%; margin-top: 10px; }
        .btn-tool { background: #334155; color: var(--accent); padding: 8px 16px; border: 1px solid var(--border); }
        .verified { color: var(--success); font-size: 10px; font-style: italic; display: none; margin-top: 4px; }

        .pos { color: var(--success); }
        .neg { color: var(--danger); }
        
        /* Modal */
        #modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:var(--card); border:1px solid var(--accent); padding:25px; border-radius:20px; z-index:9999; width:90%; max-width:400px; box-shadow: 0 25px 50px rgba(0,0,0,0.8); }
        #overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9998; backdrop-filter: blur(4px); }
        .breakdown-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 14px; }

        @media print { nav, .btn, .no-print { display: none !important; } body { background: white; color: black; } .card { border: 1px solid #ccc; } }
    </style>
</head>
<body>

<div id="overlay" onclick="closeModal()"></div>
<div id="modal">
    <h3 style="margin-top:0; color:var(--accent)">Trip Financials</h3>
    <div id="modal-content"></div>
    <button class="btn btn-primary" onclick="closeModal()" style="margin-top:15px">Close</button>
</div>

<div class="container">
    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <div style="font-size:22px; font-weight:900;">TAG<span style="color:var(--accent)">DRIVER</span>PRO</div>
        <div id="status-bar" style="font-size:12px; color:var(--warning); font-weight:700; display:none;">Processing...</div>
    </header>

    <nav class="no-print">
        <button class="nav-btn active" onclick="switchTab('input')">Load Entry</button>
        <button class="nav-btn" onclick="switchTab('map')">Week Map & Log</button>
        <button class="nav-btn" onclick="switchTab('fixed')">Settings</button>
    </nav>

    <div class="summary-grid">
        <div class="summary-box"><span class="label">Booked Gross</span><div class="value" id="wk_gross">$0.00</div></div>
        <div class="summary-box"><span class="label">Booked Miles</span><div class="value" id="wk_miles">0</div></div>
        <div class="summary-box"><span class="label">Booked Profit</span><div class="value pos" id="wk_profit">$0.00</div></div>
        <div class="summary-box"><span class="label">Avg RPM</span><div class="value" id="wk_rpm">$0.00</div></div>
    </div>

    <div id="input" class="tab-content active">
        <div class="card no-print">
            <div class="card-header">New Load Calculator</div>
            <div class="card-body">
                <div class="input-row">
                    <div class="input-group">
                        <label>Pickup City</label><input id="origin" placeholder="City, State">
                        <div id="orig-ok" class="verified"></div>
                    </div>
                    <div class="input-group">
                        <label>Drop City</label><input id="dest" placeholder="City, State">
                        <div id="dest-ok" class="verified"></div>
                    </div>
                </div>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <button class="btn btn-tool" style="background:var(--accent); color:#000;" onclick="calculateRoute()">üì° Calculate Miles</button>
                    <button class="btn btn-tool" onclick="verifyGoogle()">üó∫Ô∏è Verify Map</button>
                    <button class="btn btn-tool" onclick="openTollGuru()">üí∞ Check Tolls</button>
                </div>

                <div class="input-row">
                    <div class="input-group"><label>Loaded Miles</label><input id="mi_load" type="number" oninput="calcPreview()"></div>
                    <div class="input-group"><label>Deadhead Miles</label><input id="mi_dh" type="number" oninput="calcPreview()"></div>
                    <div class="input-group"><label>Tolls/Lumper ($)</label><input id="cost_tolls" type="number" value="0" oninput="calcPreview()"></div>
                </div>
                <div class="input-row">
                    <div class="input-group"><label>Gross Pay ($)</label><input id="pay_gross" type="number" oninput="calcPreview()"></div>
                    <div class="input-group"><label>Trip Net (Preview)</label><div id="trip_net" style="font-size:18px; font-weight:800; padding:10px; color:var(--muted);">$0.00</div></div>
                </div>
                <button class="btn btn-primary" onclick="addLoad()">Book Load</button>
            </div>
        </div>
    </div>

    <div id="map" class="tab-content">
        <div class="map-layout">
            <div class="sidebar">
                <div id="trip-list"></div>
                <button class="btn btn-tool" style="width:100%; margin-top:10px;" onclick="if(confirm('Clear all?')){localStorage.clear();location.reload();}">Reset Week</button>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <div id="fixed" class="tab-content">
        <div class="card">
            <div class="card-header">Weekly Fixed Costs</div>
            <div class="card-body">
                <div class="input-row">
                    <div class="input-group"><label>Truck Pmt</label><input id="f_truck" type="number" value="800"></div>
                    <div class="input-group"><label>Trailer Pmt</label><input id="f_trailer" type="number" value="400"></div>
                    <div class="input-group"><label>Insurance</label><input id="f_ins" type="number" value="350"></div>
                </div>
                <div class="input-row">
                    <div class="input-group"><label>Advances</label><input id="f_adv" type="number" value="0"></div>
                    <div class="input-group"><label>Food/Misc</label><input id="f_food" type="number" value="0"></div>
                    <div class="input-group"><label>Repairs</label><input id="f_rep" type="number" value="0"></div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">Specs</div>
            <div class="card-body">
                <div class="input-row">
                    <div class="input-group"><label>Split %</label><input id="spec_split" type="number" value="0.80" step="0.01"></div>
                    <div class="input-group"><label>Fuel Price</label><input id="spec_fuel" type="number" value="3.25" step="0.01"></div>
                    <div class="input-group"><label>MPG</label><input id="spec_mpg" type="number" value="6.5" step="0.1"></div>
                    <div class="input-group"><label>Maint ($/mi)</label><input id="spec_maint" type="number" value="0.17" step="0.01"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let loads = JSON.parse(localStorage.getItem('tag_v13_data') || '[]');
    let lastCoords = JSON.parse(localStorage.getItem('tag_v13_coords') || 'null'); // {lat, lon}
    let mapInstance = null;

    // --- LOGIC: TABS ---
    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(d => d.style.display='none');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).style.display='block';
        
        // Find button to set active
        const btnIndex = ['input','map','fixed'].indexOf(id);
        if(btnIndex >=0) document.querySelectorAll('.nav-btn')[btnIndex].classList.add('active');

        if(id === 'map') renderMap();
    }

    // --- LOGIC: ROUTING ---
    async function getGeo(city) {
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}, USA&limit=1`);
            const data = await res.json();
            return data[0]; // {lat, lon, display_name}
        } catch(e) { return null; }
    }

    async function calculateRoute() {
        const oStr = document.getElementById('origin').value;
        const dStr = document.getElementById('dest').value;
        const status = document.getElementById('status-bar');
        
        if(!oStr || !dStr) return alert("Enter Pickup and Drop cities.");
        
        status.style.display = 'block'; status.innerText = "Finding Cities...";
        
        const locA = await getGeo(oStr);
        const locB = await getGeo(dStr);

        if(!locA || !locB) {
            status.innerText = "Error: City not found.";
            return;
        }

        // Show verification
        document.getElementById('orig-ok').innerText = `‚úì ${locA.display_name.split(',')[0]}, ${locA.display_name.split(',')[2]}`;
        document.getElementById('orig-ok').style.display = 'block';
        document.getElementById('dest-ok').innerText = `‚úì ${locB.display_name.split(',')[0]}, ${locB.display_name.split(',')[2]}`;
        document.getElementById('dest-ok').style.display = 'block';

        status.innerText = "Routing...";
        
        // Route A -> B
        const rRes = await fetch(`https://router.project-osrm.org/route/v1/driving/${locA.lon},${locA.lat};${locB.lon},${locB.lat}?overview=false`);
        const rData = await rRes.json();
        const loaded = Math.round(rData.routes[0].distance * 0.000621371);
        document.getElementById('mi_load').value = loaded;

        // Deadhead (Last Drop -> A)
        let dh = 0;
        if(lastCoords) {
            const dhRes = await fetch(`https://router.project-osrm.org/route/v1/driving/${lastCoords.lon},${lastCoords.lat};${locA.lon},${locA.lat}?overview=false`);
            const dhData = await dhRes.json();
            dh = Math.round(dhData.routes[0].distance * 0.000621371);
            document.getElementById('mi_dh').value = dh;
        }

        // Save coords temporarily for booking
        document.getElementById('origin').dataset.coords = JSON.stringify({lat: locA.lat, lon: locA.lon});
        document.getElementById('dest').dataset.coords = JSON.stringify({lat: locB.lat, lon: locB.lon});

        status.style.display = 'none';
        calcPreview();
    }

    // --- LOGIC: CALCULATIONS ---
    function getSettings() {
        return {
            split: parseFloat(document.getElementById('spec_split').value) || 0.8,
            fuel: parseFloat(document.getElementById('spec_fuel').value) || 3.25,
            mpg: parseFloat(document.getElementById('spec_mpg').value) || 6.5,
            maint: parseFloat(document.getElementById('spec_maint').value) || 0.17,
            fixed: ['f_truck','f_trailer','f_ins','f_adv','f_food','f_rep'].reduce((s,id)=>s+(parseFloat(document.getElementById(id).value)||0),0)
        };
    }

    function calcPreview() {
        // This ONLY calculates the current input. Does NOT touch weekly stats.
        const s = getSettings();
        const gross = parseFloat(document.getElementById('pay_gross').value) || 0;
        const miles = (parseFloat(document.getElementById('mi_load').value) || 0) + (parseFloat(document.getElementById('mi_dh').value) || 0);
        const tolls = parseFloat(document.getElementById('cost_tolls').value) || 0;

        const costFuel = (miles / s.mpg) * s.fuel;
        const costMaint = miles * s.maint;
        const costFixed = s.fixed / 5; // Daily share

        const net = (gross * s.split) - costFuel - costMaint - costFixed - tolls;
        
        const el = document.getElementById('trip_net');
        el.innerText = '$' + net.toLocaleString(undefined, {minimumFractionDigits:2});
        el.className = net >= 0 ? 'pos' : 'neg';
    }

    function addLoad() {
        const gross = parseFloat(document.getElementById('pay_gross').value) || 0;
        const loaded = parseFloat(document.getElementById('mi_load').value) || 0;
        const dh = parseFloat(document.getElementById('mi_dh').value) || 0;
        const tolls = parseFloat(document.getElementById('cost_tolls').value) || 0;
        
        // Coords
        const oC = document.getElementById('origin').dataset.coords;
        const dC = document.getElementById('dest').dataset.coords;

        if(!gross || !loaded) return alert("Enter Gross Pay and Miles");

        // Calculate Final Profit
        const s = getSettings();
        const miles = loaded + dh;
        const costFuel = (miles / s.mpg) * s.fuel;
        const costMaint = miles * s.maint;
        const costFixed = s.fixed / 5;
        const net = (gross * s.split) - costFuel - costMaint - costFixed - tolls;

        const load = {
            id: Date.now(),
            origin: document.getElementById('origin').value,
            dest: document.getElementById('dest').value,
            coords: { start: oC ? JSON.parse(oC) : null, end: dC ? JSON.parse(dC) : null },
            gross, miles, net,
            details: { fuel: costFuel, maint: costMaint, fixed: costFixed, tolls, split: gross*s.split }
        };

        loads.push(load);
        
        // Update Persisted Data
        if(dC) {
            lastCoords = JSON.parse(dC);
            localStorage.setItem('tag_v13_coords', dC);
        }
        localStorage.setItem('tag_v13_data', JSON.stringify(loads));

        // Clear Inputs
        ['origin','dest','mi_load','mi_dh','pay_gross','cost_tolls'].forEach(id => document.getElementById(id).value = "");
        document.getElementById('trip_net').innerText = "$0.00";
        document.querySelectorAll('.verified').forEach(e => e.style.display='none');
        
        updateWeeklyStats();
        alert("Load Booked!");
    }

    function updateWeeklyStats() {
        // Sum ONLY the loads array
        const tg = loads.reduce((s,l) => s + l.gross, 0);
        const tm = loads.reduce((s,l) => s + l.miles, 0);
        const tp = loads.reduce((s,l) => s + l.net, 0);

        document.getElementById('wk_gross').innerText = '$' + tg.toLocaleString();
        document.getElementById('wk_miles').innerText = tm.toLocaleString();
        document.getElementById('wk_profit').innerText = '$' + tp.toLocaleString(undefined, {minimumFractionDigits:2});
        document.getElementById('wk_rpm').innerText = '$' + (tm > 0 ? (tg/tm).toFixed(2) : "0.00");
    }

    function renderMap() {
        if(mapInstance) {
            mapInstance.remove(); // clear old map
        }
        
        document.getElementById('trip-list').innerHTML = '';

        if(loads.length === 0) {
            document.getElementById('map').innerHTML = '<div style="color:white; text-align:center; padding-top:200px;">No loads booked yet</div>';
            return;
        }

        // Init Map
        mapInstance = L.map('map').setView([39.82, -98.58], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(mapInstance);

        const bounds = [];
        const latlngs = [];

        loads.forEach((l, i) => {
            // Sidebar Item
            const item = document.createElement('div');
            item.className = 'trip-card';
            item.innerHTML = `
                <div class="trip-route">${i+1}. ${l.origin} ‚ûù ${l.dest}</div>
                <div class="trip-meta">
                    <span>${l.miles} mi</span>
                    <span class="${l.net>=0?'pos':'neg'}">$${l.net.toFixed(0)}</span>
                </div>
                <button class="btn-tool" style="margin-top:5px; font-size:10px; width:100%" onclick="viewDetail(${i})">View Breakdown</button>
            `;
            document.getElementById('trip-list').appendChild(item);

            // Map Pins
            if(l.coords && l.coords.start && l.coords.end) {
                L.marker([l.coords.start.lat, l.coords.start.lon]).addTo(mapInstance).bindPopup(`Load ${i+1} Pickup`);
                L.marker([l.coords.end.lat, l.coords.end.lon]).addTo(mapInstance).bindPopup(`Load ${i+1} Drop`);
                
                const line = [[l.coords.start.lat, l.coords.start.lon], [l.coords.end.lat, l.coords.end.lon]];
                latlngs.push(line);
                bounds.push([l.coords.start.lat, l.coords.start.lon]);
                bounds.push([l.coords.end.lat, l.coords.end.lon]);
            }
        });

        if(latlngs.length > 0) {
            L.polyline(latlngs, {color: '#38bdf8', weight: 3}).addTo(mapInstance);
            mapInstance.fitBounds(bounds, {padding: [50,50]});
        }
    }

    function viewDetail(i) {
        const l = loads[i];
        const h = `
            <div class="breakdown-row"><span>Gross Pay:</span><span>$${l.gross.toFixed(2)}</span></div>
            <div class="breakdown-row"><span>Your Split:</span><span class="pos">$${l.details.split.toFixed(2)}</span></div>
            <div class="breakdown-row"><span>Fuel Cost:</span><span class="neg">-$${l.details.fuel.toFixed(2)}</span></div>
            <div class="breakdown-row"><span>Fixed Cost Share:</span><span class="neg">-$${l.details.fixed.toFixed(2)}</span></div>
            <div class="breakdown-row"><span>Tolls/Fees:</span><span class="neg">-$${l.details.tolls.toFixed(2)}</span></div>
            <div class="breakdown-row" style="border-top:2px solid var(--accent); margin-top:10px; font-weight:800; font-size:18px;">
                <span>Net Profit:</span><span class="${l.net>=0?'pos':'neg'}">$${l.net.toFixed(2)}</span>
            </div>
        `;
        document.getElementById('modal-content').innerHTML = h;
        document.getElementById('modal').style.display='block';
        document.getElementById('overlay').style.display='block';
    }

    function closeModal() {
        document.getElementById('modal').style.display='none';
        document.getElementById('overlay').style.display='none';
    }

    function verifyGoogle() {
        const o = document.getElementById('origin').value;
        const d = document.getElementById('dest').value;
        if(o&&d) window.open(`http://maps.google.com/maps?q=from:${encodeURIComponent(o)}+to:${encodeURIComponent(d)}`);
    }

    function openTollGuru() {
        const o = document.getElementById('origin').value;
        const d = document.getElementById('dest').value;
        if(o&&d) {
            navigator.clipboard.writeText(`${o} to ${d}`);
            alert("Route copied. Paste into TollGuru.");
            window.open('https://tollguru.com/toll-calculator');
        }
    }

    // Init
    switchTab('input');
    updateWeeklyStats();
</script>
</body>
</html>
