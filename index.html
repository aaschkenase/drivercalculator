<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
    <title>Tag Driver Pro | Fleet Intelligence</title>
    <style>
        :root { 
            --bg: #0b0f1a; --card: #161e2e; --border: #2d3748;
            --accent: #38bdf8; --text: #f1f5f9; --muted: #94a3b8;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
        }
        * { box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 80px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        nav { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid var(--border); padding-bottom: 12px; overflow-x: auto; }
        .nav-btn { padding: 12px 24px; border-radius: 10px; border: none; background: transparent; color: var(--muted); cursor: pointer; font-weight: 700; white-space: nowrap; }
        .nav-btn.active { background: var(--accent); color: var(--bg); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .summary-box { background: #1e293b; border: 1px solid var(--border); padding: 20px; border-radius: 18px; }
        .label { font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: 800; margin-bottom: 8px; display: block; }
        .value { font-size: 24px; font-weight: 900; }

        .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; margin-bottom: 25px; }
        .card-header { padding: 16px 24px; border-bottom: 1px solid var(--border); font-weight: 800; font-size: 11px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        .card-body { padding: 24px; }

        .input-row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
        .input-group { flex: 1; min-width: 220px; }
        label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 8px; }
        input { background: #0f172a; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 10px; font-weight: 600; width: 100%; border: 1.5px solid var(--border); }
        input:focus { border-color: var(--accent); outline: none; }

        .btn { padding: 14px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: var(--bg); width: 100%; margin-top: 10px; }
        .btn-primary:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn-tool { background: #334155; color: var(--accent); margin-bottom: 10px; font-size: 12px; width: auto; padding: 8px 16px; border: 1px solid var(--accent); }
        
        #modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:var(--card); border:1px solid var(--accent); padding:30px; border-radius:24px; z-index:1000; width:90%; max-width:400px; }
        #overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999; backdrop-filter: blur(4px); }
        .breakdown-line { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }

        .pos { color: var(--success); }
        .neg { color: var(--danger); }
        #status-msg { font-size: 12px; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: none; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 15px; text-align: left; border-bottom: 1px solid var(--border); font-size: 14px; }
        .view-link { color: var(--accent); font-weight: 800; cursor: pointer; text-decoration: underline; font-size: 11px; text-transform: uppercase; }

        @media print {
            nav, .btn, #status-msg, .no-print { display: none !important; }
            .card { border: 1px solid #eee; box-shadow: none; }
            body { background: white; color: black; }
        }
    </style>
</head>
<body>

<div id="overlay" onclick="closeModal()"></div>
<div id="modal">
    <h2 style="margin-top:0; font-size: 18px; color: var(--accent);">TRIP SETTLEMENT DETAIL</h2>
    <div id="modal-content" style="font-size: 14px;"></div>
    <button class="btn btn-primary" onclick="closeModal()" style="margin-top:20px;">Close Detail</button>
</div>

<div class="container">
    <header style="margin-bottom:25px; display: flex; justify-content: space-between; align-items: center;">
        <div class="logo" style="font-size: 24px; font-weight: 900; letter-spacing: -1px;">TAG<span style="color:var(--accent)">DRIVER</span>PRO</div>
        <div id="live-clock" style="font-size: 12px; color: var(--muted); font-weight: 600;"></div>
    </header>

    <nav class="no-print">
        <button class="nav-btn active" onclick="showTab('dashboard', this)">Weekly Load Log</button>
        <button class="nav-btn" onclick="showTab('fixed', this)">Costs & Settings</button>
        <button class="nav-btn" onclick="showTab('analytics', this)">Annual Stats</button>
    </nav>

    <div id="dashboard" class="tab-content active">
        <div class="summary-grid">
            <div class="summary-box"><span class="label">Gross Weekly</span><div class="value" id="week_gross">$0.00</div></div>
            <div class="summary-box"><span class="label">Weekly Miles</span><div class="value" id="week_miles">0</div></div>
            <div class="summary-box"><span class="label">Net Profit</span><div class="value pos" id="week_profit">$0.00</div></div>
            <div class="summary-box"><span class="label">Avg RPM</span><div class="value" id="week_rpm">$0.00</div></div>
        </div>

        <div class="card no-print">
            <div class="card-header">Step 1: Trip & Route Planner</div>
            <div class="card-body">
                <div id="status-msg"></div>
                <div class="input-row">
                    <div class="input-group"><label>Pickup City/State</label><input id="origin" placeholder="City, State"></div>
                    <div class="input-group"><label>Drop City/State</label><input id="dest" placeholder="City, State"></div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-tool" onclick="runSmartRoute()">üó∫Ô∏è Calculate Miles & DH</button>
                    <button class="btn btn-tool" onclick="lookupTolls()" style="color: var(--warning); border-color: var(--warning);">üí∞ Look up Tolls</button>
                </div>
                
                <div class="input-row">
                    <div class="input-group"><label>Loaded Miles</label><input id="miles_loaded" type="number" value="0" oninput="manualUpdate()"></div>
                    <div class="input-group"><label>Deadhead Miles</label><input id="miles_deadhead" type="number" value="0" oninput="manualUpdate()"></div>
                    <div class="input-group"><label>Tolls / Lumper ($)</label><input id="load_tolls" type="number" value="0" oninput="manualUpdate()"></div>
                </div>
                <div class="input-row">
                    <div class="input-group"><label>Gross Pay ($)</label><input id="gross" type="number" placeholder="Total revenue for load" oninput="manualUpdate()"></div>
                </div>
                <button class="btn btn-primary" onclick="addLoad()">Save Load to Weekly History</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Trip History Log</div>
            <div style="overflow-x:auto;">
                <table>
                    <thead><tr><th>Route</th><th>Miles</th><th>Gross</th><th>Net Profit</th><th>Breakdown</th><th></th></tr></thead>
                    <tbody id="loadList"></tbody>
                </table>
            </div>
            <button class="btn btn-primary" style="background:var(--border); margin-top:20px;" onclick="window.print()">Print Weekly Summary</button>
        </div>
    </div>

    <div id="fixed" class="tab-content">
        <div class="card">
            <div class="card-header">A. Weekly Fixed Business Costs</div>
            <div class="card-body">
                <div class="input-row">
                    <div class="input-group"><label>Truck Pmt</label><input id="f_truck" type="number" value="800"></div>
                    <div class="input-group"><label>Trailer Pmt</label><input id="f_trailer" type="number" value="400"></div>
                    <div class="input-group"><label>Insurance</label><input id="f_ins" type="number" value="350"></div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">B. Weekly Extra Deductions</div>
            <div class="card-body">
                <div class="input-row">
                    <div class="input-group"><label>Advances</label><input id="f_adv" type="number" value="0"></div>
                    <div class="input-group"><label>Food/Personal</label><input id="f_food" type="number" value="0"></div>
                    <div class="input-group"><label>Other/Repairs</label><input id="f_misc" type="number" value="0"></div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">C. Performance settings</div>
            <div class="card-body">
                <div class="input-row">
                    <div class="input-group"><label>Rev Split % (0.80)</label><input id="r_split" type="number" value="0.80" step="0.01"></div>
                    <div class="input-group"><label>Net Fuel Price</label><input id="f_net" type="number" value="3.25" step="0.01"></div>
                    <div class="input-group"><label>Maint Rate</label><input id="m_rate" type="number" value="0.17" step="0.01"></div>
                    <div class="input-group"><label>Truck MPG</label><input id="mpg" type="number" value="6.5" step="0.1"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="analytics" class="tab-content">
        <div class="summary-grid">
            <div class="summary-box"><span class="label">YTD Gross Revenue</span><div class="value" id="ann_gross">$0.00</div></div>
            <div class="summary-box"><span class="label">YTD Net Profit</span><div class="value pos" id="ann_profit">$0.00</div></div>
            <div class="summary-box"><span class="label">Tax Savings Goal</span><div class="value neg" id="ann_tax">$0.00</div></div>
        </div>
        <button class="btn btn-primary" style="background:var(--danger); width:auto;" onclick="if(confirm('Wipe everything?')) {localStorage.clear(); location.reload();}">Hard Reset Database</button>
    </div>
</div>

<script>
    let loads = JSON.parse(localStorage.getItem('tag_v11_data') || '[]');
    let lastDrop = localStorage.getItem('v11_last_drop') || "";

    function showTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    function setStatus(msg, isError = false) {
        const el = document.getElementById('status-msg');
        el.style.display = 'block';
        el.style.background = isError ? 'rgba(239, 68, 68, 0.2)' : 'rgba(56, 189, 248, 0.2)';
        el.style.color = isError ? 'var(--danger)' : 'var(--accent)';
        el.innerText = msg;
    }

    function lookupTolls() {
        const origin = document.getElementById('origin').value;
        const dest = document.getElementById('dest').value;
        if(!origin || !dest) return alert("Enter Pickup and Drop cities first.");
        const url = `https://tollguru.com/toll-calculator?from=${encodeURIComponent(origin)}&to=${encodeURIComponent(dest)}&vehicleType=5-axle-truck`;
        window.open(url, '_blank');
    }

    async function runSmartRoute() {
        const originStr = document.getElementById('origin').value;
        const destStr = document.getElementById('dest').value;

        if (!originStr || !destStr) return setStatus("‚ö†Ô∏è Pickup and Drop are required.", true);
        
        setStatus("üì° Connecting to routing satellite...");

        try {
            const locA = await (await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(originStr)}&limit=1`)).json();
            const locB = await (await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(destStr)}&limit=1`)).json();

            if (!locA[0] || !locB[0]) throw new Error("City not found");

            const routeData = await (await fetch(`https://router.project-osrm.org/route/v1/driving/${locA[0].lon},${locA[0].lat};${locB[0].lon},${locB[0].lat}?overview=false`)).json();
            const loaded = Math.round(routeData.routes[0].distance * 0.000621371);
            document.getElementById('miles_loaded').value = loaded;

            if (lastDrop) {
                const locPrev = await (await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(lastDrop)}&limit=1`)).json();
                if(locPrev[0]) {
                    const dhData = await (await fetch(`https://router.project-osrm.org/route/v1/driving/${locPrev[0].lon},${locPrev[0].lat};${locA[0].lon},${locA[0].lat}?overview=false`)).json();
                    document.getElementById('miles_deadhead').value = Math.round(dhData.routes[0].distance * 0.000621371);
                }
            }

            setStatus("‚úÖ Route Calculated Successfully.");
            manualUpdate();
        } catch (e) {
            setStatus("‚ùå Map Error: Enter miles manually or check spelling.", true);
        }
    }

    function manualUpdate() {
        const loaded = parseFloat(document.getElementById('miles_loaded').value) || 0;
        const dh = parseFloat(document.getElementById('miles_deadhead').value) || 0;
        const gross = parseFloat(document.getElementById('gross').value) || 0;
        const tolls = parseFloat(document.getElementById('load_tolls').value) || 0;
        const split = parseFloat(document.getElementById('r_split').value) || 0.8;
        const fNet = parseFloat(document.getElementById('f_net').value) || 3.25;
        const mpg = parseFloat(document.getElementById('mpg').value) || 6.5;
        const mRate = parseFloat(document.getElementById('m_rate').value) || 0.17;
        
        const weeklyFixed = ['f_truck', 'f_trailer', 'f_ins', 'f_adv', 'f_food', 'f_misc'].reduce((s, id) => s + (parseFloat(document.getElementById(id).value) || 0), 0);

        const totalMiles = loaded + dh;
        const fuel = (totalMiles / mpg) * fNet;
        const maint = totalMiles * mRate;
        const profit = (gross * split) - fuel - maint - (weeklyFixed / 5) - tolls;

        const tg = loads.reduce((s,l) => s + l.gross, 0) + gross;
        const tm = loads.reduce((s,l) => s + l.miles, 0) + totalMiles;
        const tp = loads.reduce((s,l) => s + l.profit, 0) + profit;

        document.getElementById('week_gross').innerText = money(tg);
        document.getElementById('week_miles').innerText = tm.toLocaleString();
        document.getElementById('week_profit').innerText = money(tp);
        document.getElementById('week_rpm').innerText = money(tm > 0 ? tg / tm : 0);
        document.getElementById('ann_gross').innerText = money(tg);
        document.getElementById('ann_profit').innerText = money(tp);
        document.getElementById('ann_tax').innerText = money(tp * 0.25);

        return { profit, totalMiles, fuel, maint, fixed: weeklyFixed/5, tolls, gross, cut: gross * split };
    }

    function addLoad() {
        const res = manualUpdate();
        loads.push({
            route: `${document.getElementById('origin').value} ‚á¢ ${document.getElementById('dest').value}`,
            miles: res.totalMiles, gross: res.gross, profit: res.profit, fuel: res.fuel,
            maint: res.maint, tolls: res.tolls, fixed: res.fixed, cut: res.cut
        });
        lastDrop = document.getElementById('dest').value;
        localStorage.setItem('v11_last_drop', lastDrop);
        saveAndRender();
        ['origin', 'dest', 'gross', 'load_tolls'].forEach(i => document.getElementById(i).value = i.includes('origin') || i.includes('dest') ? "" : 0);
    }

    function saveAndRender() {
        localStorage.setItem('tag_v11_data', JSON.stringify(loads));
        document.getElementById('loadList').innerHTML = loads.map((l, i) => `
            <tr>
                <td style="font-weight:700;">${l.route}</td><td>${l.miles}</td><td>$${l.gross}</td>
                <td class="${l.profit >= 0 ? 'pos' : 'neg'}">${money(l.profit)}</td>
                <td><span class="view-link" onclick="viewDetails(${i})">View Detail</span></td>
                <td><button onclick="removeLoad(${i})" style="color:var(--danger); background:none; border:none; cursor:pointer">‚úï</button></td>
            </tr>
        `).join('');
        manualUpdate();
    }

    function viewDetails(i) {
        const l = loads[i];
        document.getElementById('modal-content').innerHTML = `
            <div class="breakdown-line"><span>Load Gross:</span><span>${money(l.gross)}</span></div>
            <div class="breakdown-line"><span>Split Cut (Paycheck):</span><span class="pos">${money(l.cut)}</span></div>
            <div class="breakdown-line"><span>Fuel Burn:</span><span class="neg">-${money(l.fuel)}</span></div>
            <div class="breakdown-line"><span>Maintenance Savings:</span><span class="neg">-${money(l.maint)}</span></div>
            <div class="breakdown-line"><span>Tolls & Lumper:</span><span class="neg">-${money(l.tolls)}</span></div>
            <div class="breakdown-line"><span>Fixed Cost Share:</span><span class="neg">-${money(l.fixed)}</span></div>
            <div class="breakdown-line" style="border-top:2px solid var(--accent); margin-top:10px; font-weight:900; font-size: 16px;">
                <span>NET TRIP PROFIT:</span><span class="${l.profit >= 0 ? 'pos' : 'neg'}">${money(l.profit)}</span>
            </div>
        `;
        document.getElementById('modal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }
    function removeLoad(i) { loads.splice(i, 1); saveAndRender(); }
    function money(v) { return '$' + Number(v).toLocaleString(undefined, {minimumFractionDigits: 2}); }
    
    document.getElementById('live-clock').innerText = new Date().toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
    saveAndRender();
</script>
</body>
</html>
