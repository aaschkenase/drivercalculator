<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
    <title>Tag Driver | Automated Logistics</title>
    <style>
        :root { 
            --bg: #0f172a; --card: #1e293b; --border: #334155;
            --accent: #38bdf8; --text: #f1f5f9; --muted: #94a3b8;
            --success: #4ade80; --danger: #fb7185; --warning: #fbbf24;
        }
        * { box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 60px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        
        /* Navigation Tabs */
        nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .nav-btn { padding: 10px 20px; border-radius: 8px; border: none; background: transparent; color: var(--muted); cursor: pointer; font-weight: 700; }
        .nav-btn.active { background: var(--accent); color: var(--bg); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logo { font-size: 20px; font-weight: 800; color: var(--accent); }

        .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; margin-bottom: 20px; }
        .card-header { padding: 14px 20px; border-bottom: 1px solid var(--border); background: #ffffff05; font-weight: 700; font-size: 11px; color: var(--accent); text-transform: uppercase; }
        .card-body { padding: 20px; }

        .input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 15px; }
        input { background: #0f172a; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 8px; font-weight: 600; width: 100%; }
        .val-input { width: 120px; text-align: right; }

        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .summary-box { background: #0ea5e910; border: 1px solid var(--accent); padding: 15px; border-radius: 12px; }
        .label { font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: 700; }
        .value { font-size: 22px; font-weight: 800; }

        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; width: 100%; font-size: 14px; }
        .btn-primary { background: var(--accent); color: var(--bg); }
        .btn-ghost { background: var(--border); color: white; margin-top: 10px; }

        .pos { color: var(--success); }
        .neg { color: var(--danger); }
        .loading-text { font-size: 12px; color: var(--warning); display: none; }

        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); font-size: 13px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo">TAG<span>DRIVER</span> PRO</div>
        <div id="status" class="loading-text">Calculating Route...</div>
    </header>

    <nav>
        <button class="nav-btn active" onclick="showTab('dashboard')">Load Manager</button>
        <button class="nav-btn" onclick="showTab('fixed')">Fixed Costs</button>
    </nav>

    <div id="dashboard" class="tab-content active">
        <div class="summary-grid">
            <div class="summary-box"><div class="label">Weekly Gross</div><div class="value" id="week_gross">$0.00</div></div>
            <div class="summary-box"><div class="label">Total Net Profit</div><div class="value pos" id="week_profit">$0.00</div></div>
            <div class="summary-box"><div class="label">Weekly All-In RPM</div><div class="value" id="week_rpm">$0.00</div></div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr; gap: 20px;" id="main-layout">
            <div class="card">
                <div class="card-header">New Trip Entry</div>
                <div class="card-body">
                    <div class="input-row">
                        <div style="flex:1"><label class="label">Origin</label><input id="origin" placeholder="City, State" onblur="autoCalcMiles()"></div>
                        <div style="flex:1"><label class="label">Destination</label><input id="dest" placeholder="City, State" onblur="autoCalcMiles()"></div>
                    </div>
                    <div class="input-row">
                        <div><label class="label">Loaded Miles</label><input id="miles_loaded" class="val-input" type="number" oninput="calc()"></div>
                        <div><label class="label">Deadhead</label><input id="miles_deadhead" class="val-input" type="number" oninput="calc()"></div>
                        <div><label class="label">Gross $</label><input id="gross" class="val-input" type="number" value="0" oninput="calc()"></div>
                    </div>
                    <button class="btn btn-primary" onclick="addLoad()">Add Load to Weekly Summary</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Weekly History</div>
                <div style="overflow-x:auto">
                    <table>
                        <thead><tr><th>Route</th><th>Miles</th><th>Gross</th><th>Net</th><th></th></tr></thead>
                        <tbody id="loadList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="fixed" class="tab-content">
        <div class="card">
            <div class="card-header">Adjust Weekly Business Costs</div>
            <div class="card-body">
                <div class="input-row"><label class="label">Truck Payment</label><input id="f_truck" class="val-input" type="number" value="800" oninput="calc()"></div>
                <div class="input-row"><label class="label">Trailer Payment</label><input id="f_trailer" class="val-input" type="number" value="400" oninput="calc()"></div>
                <div class="input-row"><label class="label">Insurance</label><input id="f_ins" class="val-input" type="number" value="350" oninput="calc()"></div>
                <div class="input-row"><label class="label">Maintenance Rate ($/mi)</label><input id="m_rate" class="val-input" type="number" value="0.17" step="0.01" oninput="calc()"></div>
                <div class="input-row"><label class="label">Revenue Split (Ex: 0.80)</label><input id="r_split" class="val-input" type="number" value="0.80" step="0.01" oninput="calc()"></div>
                <div class="input-row"><label class="label">Fuel Net Price ($)</label><input id="f_net" class="val-input" type="number" value="3.25" step="0.01" oninput="calc()"></div>
                <div class="input-row"><label class="label">Truck MPG</label><input id="mpg" class="val-input" type="number" value="6.5" step="0.1" oninput="calc()"></div>
                <button class="btn btn-ghost" onclick="showTab('dashboard')">Back to Dashboard</button>
            </div>
        </div>
    </div>
</div>

<script>
    let loads = JSON.parse(localStorage.getItem('tag_v6_data') || '[]');
    let lastDestination = localStorage.getItem('last_dest') || "";

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    async function getMiles(start, end) {
        if(!start || !end) return 0;
        try {
            document.getElementById('status').style.display = 'block';
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(start)}`);
            const res2 = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(end)}`);
            const d1 = await res.json();
            const d2 = await res2.json();
            
            const route = await fetch(`https://router.project-osrm.org/route/v1/driving/${d1[0].lon},${d1[0].lat};${d2[0].lon},${d2[0].lat}?overview=false`);
            const data = await route.json();
            document.getElementById('status').style.display = 'none';
            return Math.round(data.routes[0].distance * 0.000621371); // convert meters to miles
        } catch (e) {
            document.getElementById('status').style.display = 'none';
            return 0;
        }
    }

    async function autoCalcMiles() {
        const origin = document.getElementById('origin').value;
        const dest = document.getElementById('dest').value;

        // Auto Loaded Miles
        if(origin && dest) {
            const miles = await getMiles(origin, dest);
            document.getElementById('miles_loaded').value = miles;
        }

        // Auto Deadhead from last load
        if(origin && lastDestination) {
            const dh = await getMiles(lastDestination, origin);
            document.getElementById('miles_deadhead').value = dh;
        }
        calc();
    }

    function calc() {
        const loaded = parseFloat(document.getElementById('miles_loaded').value) || 0;
        const dh = parseFloat(document.getElementById('miles_deadhead').value) || 0;
        const gross = parseFloat(document.getElementById('gross').value) || 0;
        const split = parseFloat(document.getElementById('r_split').value) || 0.8;
        const fuelN = parseFloat(document.getElementById('f_net').value) || 3.25;
        const mpg = parseFloat(document.getElementById('mpg').value) || 6.5;
        const mRate = parseFloat(document.getElementById('m_rate').value) || 0.17;
        const fixed = (parseFloat(document.getElementById('f_truck').value) || 0) + 
                      (parseFloat(document.getElementById('f_trailer').value) || 0) + 
                      (parseFloat(document.getElementById('f_ins').value) || 0);

        const totalMiles = loaded + dh;
        const yourCut = gross * split;
        const expenses = ((totalMiles/mpg)*fuelN) + (totalMiles*mRate) + (fixed/5);
        const profit = yourCut - expenses;

        updateWeeklySummary();
        return { profit, totalMiles };
    }

    function addLoad() {
        const res = calc();
        const origin = document.getElementById('origin').value;
        const dest = document.getElementById('dest').value;
        
        loads.push({
            route: `${origin} to ${dest}`,
            miles: res.totalMiles,
            gross: parseFloat(document.getElementById('gross').value) || 0,
            profit: res.profit
        });

        lastDestination = dest;
        localStorage.setItem('last_dest', lastDestination);
        
        document.getElementById('origin').value = "";
        document.getElementById('dest').value = "";
        document.getElementById('gross').value = 0;
        
        saveAndRender();
    }

    function updateWeeklySummary() {
        const tGross = loads.reduce((sum, l) => sum + l.gross, 0);
        const tMiles = loads.reduce((sum, l) => sum + l.miles, 0);
        const tProfit = loads.reduce((sum, l) => sum + l.profit, 0);
        
        document.getElementById('week_gross').innerText = money(tGross);
        document.getElementById('week_profit').innerText = money(tProfit);
        document.getElementById('week_rpm').innerText = money(tMiles > 0 ? tGross / tMiles : 0);
    }

    function saveAndRender() {
        localStorage.setItem('tag_v6_data', JSON.stringify(loads));
        const list = document.getElementById('loadList');
        list.innerHTML = loads.map((l, i) => `
            <tr>
                <td>${l.route}</td><td>${l.miles}</td><td>$${l.gross}</td>
                <td class="${l.profit >= 0 ? 'pos' : 'neg'}">${money(l.profit)}</td>
                <td><button onclick="removeLoad(${i})" style="color:var(--danger); background:none; border:none; cursor:pointer">âœ•</button></td>
            </tr>
        `).join('');
        updateWeeklySummary();
    }

    function removeLoad(i) { loads.splice(i,1); saveAndRender(); }
    function money(v) { return '$' + Number(v).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}); }

    saveAndRender();
</script>
</body>
</html>
