<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
    <title>Tag Driver Pro | Ultimate Analytics</title>
    <style>
        :root { 
            --bg: #0b0f1a; --card: #161e2e; --border: #2d3748;
            --accent: #38bdf8; --text: #f1f5f9; --muted: #94a3b8;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 80px; }
        .container { max-width: 1300px; margin: 0 auto; padding: 20px; }
        
        /* Navigation Tabs */
        nav { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid var(--border); padding-bottom: 12px; overflow-x: auto; }
        .nav-btn { padding: 12px 24px; border-radius: 10px; border: none; background: transparent; color: var(--muted); cursor: pointer; font-weight: 700; transition: 0.3s; white-space: nowrap; }
        .nav-btn.active { background: var(--accent); color: var(--bg); box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3); }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Dashboard Stats */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-box { background: linear-gradient(145deg, #1e293b, #111827); border: 1px solid var(--border); padding: 20px; border-radius: 18px; position: relative; overflow: hidden; }
        .summary-box::after { content: ""; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--accent); }
        .label { font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: 800; letter-spacing: 1px; margin-bottom: 8px; display: block; }
        .value { font-size: 28px; font-weight: 900; }

        /* Forms */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; margin-bottom: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .card-header { padding: 16px 24px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.03); font-weight: 800; font-size: 12px; color: var(--accent); text-transform: uppercase; letter-spacing: 1.5px; }
        .card-body { padding: 24px; }

        .input-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 18px; }
        .input-group { flex: 1; min-width: 200px; }
        label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 8px; color: var(--text); }
        input { background: #0f172a; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 10px; font-weight: 600; width: 100%; transition: border 0.2s; }
        input:focus { outline: none; border-color: var(--accent); background: #1e293b; }

        .btn { padding: 14px 28px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; transition: 0.2s; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: var(--accent); color: var(--bg); width: 100%; }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .btn-ghost { background: var(--border); color: white; margin-top: 10px; width: 100%; }
        .btn-route { background: #334155; color: var(--accent); width: auto; padding: 10px 20px; font-size: 12px; margin-top: 5px; }

        /* Tables */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px 20px; background: rgba(0,0,0,0.2); font-size: 11px; text-transform: uppercase; color: var(--muted); border-bottom: 2px solid var(--border); }
        td { padding: 16px 20px; border-bottom: 1px solid var(--border); font-size: 14px; font-weight: 500; }
        
        .badge-view { background: #0ea5e920; color: var(--accent); padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; border: 1px solid var(--accent); text-transform: uppercase; }
        .badge-view:hover { background: var(--accent); color: var(--bg); }

        /* Modal */
        #modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:var(--card); border:1px solid var(--accent); padding:30px; border-radius:24px; z-index:1000; box-shadow:0 0 100px rgba(0,0,0,0.9); width:95%; max-width:450px; }
        #overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:999; backdrop-filter: blur(5px); }
        
        .breakdown-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 15px; }
        .breakdown-row.total { border-top: 2px solid var(--accent); border-bottom: none; font-weight: 900; font-size: 18px; margin-top: 15px; color: var(--text); }

        .pos { color: var(--success); }
        .neg { color: var(--danger); }
        #status-bar { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 50px; background: var(--warning); color: black; font-weight: 900; font-size: 12px; display: none; z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        @media print {
            nav, .no-print, .btn, .badge-view { display: none !important; }
            .card { box-shadow: none; border: 1px solid #ccc; }
            body { background: white; color: black; }
        }
    </style>
</head>
<body>

<div id="status-bar">üì° CALCULATING ROUTE...</div>
<div id="overlay" onclick="closeModal()"></div>
<div id="modal">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0; font-size:20px;">Trip Financials</h2>
        <span onclick="closeModal()" style="cursor:pointer; font-size:24px; color:var(--muted)">√ó</span>
    </div>
    <div id="modal-content"></div>
    <button class="btn btn-ghost" onclick="closeModal()">Close Window</button>
</div>

<div class="container">
    <header style="margin-bottom:30px;">
        <div class="logo" style="font-size:26px;">TAG<span style="color:var(--text); font-weight:200;">DRIVER</span><span style="color:var(--accent)">PRO</span></div>
        <div id="date-display" style="color:var(--muted); font-weight:700; font-size:14px; margin-top:5px;"></div>
    </header>

    <nav class="no-print">
        <button class="nav-btn active" onclick="showTab('dashboard', this)">Weekly Load Manager</button>
        <button class="nav-btn" onclick="showTab('fixed', this)">Business Costs & Settings</button>
        <button class="nav-btn" onclick="showTab('analytics', this)">Annual Analytics</button>
    </nav>

    <div id="dashboard" class="tab-content active">
        <div class="summary-grid">
            <div class="summary-box"><span class="label">Gross Revenue</span><div class="value" id="week_gross">$0.00</div></div>
            <div class="summary-box"><span class="label">Weekly Miles</span><div class="value" id="week_miles">0</div></div>
            <div class="summary-box"><span class="label">All-In RPM</span><div class="value" id="week_rpm">$0.00</div></div>
            <div class="summary-box" style="background:rgba(16, 185, 129, 0.1); border-color:var(--success);"><span class="label">Net Settlement</span><div class="value pos" id="week_profit">$0.00</div></div>
        </div>

        <div class="card no-print">
            <div class="card-header">1. Route & Pay Entry</div>
            <div class="card-body">
                <div class="input-row">
                    <div class="input-group"><label>Pickup City, State</label><input id="origin" placeholder="Ex: Chicago, IL"></div>
                    <div class="input-group"><label>Drop City, State</label><input id="dest" placeholder="Ex: Dallas, TX"></div>
                </div>
                <div style="margin-bottom:20px;"><button class="btn btn-route" onclick="triggerAutoRoute()">üîç Calculate Miles & Deadhead</button></div>
                
                <div class="input-row">
                    <div class="input-group"><label>Loaded Miles</label><input id="miles_loaded" type="number" value="0" oninput="manualCalc()"></div>
                    <div class="input-group"><label>Deadhead Miles</label><input id="miles_deadhead" type="number" value="0" oninput="manualCalc()"></div>
                </div>
                <div class="input-row">
                    <div class="input-group"><label>Gross Load Pay ($)</label><input id="gross" type="number" placeholder="Total revenue" oninput="manualCalc()"></div>
                    <div class="input-group"><label>Tolls/Lumper for this Load</label><input id="load_tolls" type="number" value="0" oninput="manualCalc()"></div>
                </div>
                <button class="btn btn-primary" onclick="addLoad()">Add This Load to Week</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Weekly History Log</div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Route</th><th>Total Mi</th><th>Gross Pay</th><th>Net Profit</th><th>Breakdown</th><th></th></tr></thead>
                    <tbody id="loadList"></tbody>
                </table>
            </div>
            <div class="card-body no-print">
                <button class="btn btn-ghost" onclick="window.print()">Print Weekly Summary Report</button>
            </div>
        </div>
    </div>

    <div id="fixed" class="tab-content">
        <div class="card">
            <div class="card-header">Fixed Recurring Weekly Costs</div>
            <div class="card-body">
                <div class="input-row">
                    <div class="input-group"><label>Truck Payment</label><input id="f_truck" type="number" value="800" oninput="manualCalc()"></div>
                    <div class="input-group"><label>Trailer Payment</label><input id="f_trailer" type="number" value="400" oninput="manualCalc()"></div>
                    <div class="input-group"><label>Insurance (Wkly)</label><input id="f_ins" type="number" value="350" oninput="manualCalc()"></div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">Variable Adjustments (Weekly)</div>
            <div class="card-body">
                <div class="input-row">
                    <div class="input-group"><label>Advance Repayments</label><input id="f_advance" type="number" value="0" oninput="manualCalc()"></div>
                    <div class="input-group"><label>Weekly Food/Personal</label><input id="f_food" type="number" value="0" oninput="manualCalc()"></div>
                    <div class="input-group"><label>Misc Weekly Repairs</label><input id="f_repairs" type="number" value="0" oninput="manualCalc()"></div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">Business Efficiency Settings</div>
            <div class="card-body">
                <div class="input-row">
                    <div class="input-group"><label>Revenue Split %</label><input id="r_split" type="number" value="0.80" step="0.01" oninput="manualCalc()"></div>
                    <div class="input-group"><label>Maint. Saving ($/mi)</label><input id="m_rate" type="number" value="0.17" step="0.01" oninput="manualCalc()"></div>
                    <div class="input-group"><label>Net Fuel Price ($)</label><input id="f_net" type="number" value="3.25" step="0.01" oninput="manualCalc()"></div>
                    <div class="input-group"><label>Truck MPG</label><input id="mpg" type="number" value="6.5" step="0.1" oninput="manualCalc()"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="analytics" class="tab-content">
        <div class="summary-grid">
            <div class="summary-box"><span class="label">Total Annual Gross</span><div class="value" id="ann_gross">$0.00</div></div>
            <div class="summary-box"><span class="label">Total Annual Net</span><div class="value pos" id="ann_profit">$0.00</div></div>
            <div class="summary-box"><span class="label">Tax Savings Req (27%)</span><div class="value neg" id="ann_tax">$0.00</div></div>
        </div>
        <div class="card">
            <div class="card-header">Business Health Metrics</div>
            <div class="card-body">
                <div class="breakdown-row"><span>Operating Expense Ratio (OER):</span><span id="oer_val">0%</span></div>
                <div class="breakdown-row"><span>Total Maintenance Saved (YTD):</span><span id="ann_maint" class="pos">$0.00</span></div>
                <div class="breakdown-row"><span>Average Weekly Profit:</span><span id="ann_wk_avg">$0.00</span></div>
            </div>
        </div>
        <button class="btn btn-outline" style="color:var(--danger); border:1px solid var(--danger); background:transparent; margin-top:50px;" onclick="hardReset()">Factory Reset All Data</button>
    </div>
</div>

<script>
    let loads = JSON.parse(localStorage.getItem('tag_v9_data') || '[]');
    let lastDrop = localStorage.getItem('last_drop_v9') || "";

    function showTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    async function triggerAutoRoute() {
        const origin = document.getElementById('origin').value;
        const dest = document.getElementById('dest').value;
        if(!origin || !dest) return alert("Please enter both Pickup and Drop cities.");
        
        document.getElementById('status-bar').style.display = 'block';
        
        // 1. Calculate Loaded Miles
        const loaded = await getMiles(origin, dest);
        document.getElementById('miles_loaded').value = loaded;
        
        // 2. Calculate Deadhead from previous drop
        if(lastDrop) {
            const dh = await getMiles(lastDrop, origin);
            document.getElementById('miles_deadhead').value = dh;
        }
        
        document.getElementById('status-bar').style.display = 'none';
        manualCalc();
    }

    async function getMiles(start, end) {
        try {
            const s1 = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(start)}`);
            const s2 = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(end)}`);
            const d1 = await s1.json(); const d2 = await s2.json();
            
            if(d1[0] && d2[0]) {
                const r = await fetch(`https://router.project-osrm.org/route/v1/driving/${d1[0].lon},${d1[0].lat};${d2[0].lon},${d2[0].lat}?overview=false`);
                const rd = await r.json();
                return Math.round(rd.routes[0].distance * 0.000621371);
            }
        } catch(e) { console.error("Route error:", e); }
        return 0;
    }

    function manualCalc() {
        const loaded = parseFloat(document.getElementById('miles_loaded').value) || 0;
        const dh = parseFloat(document.getElementById('miles_deadhead').value) || 0;
        const gross = parseFloat(document.getElementById('gross').value) || 0;
        const tolls = parseFloat(document.getElementById('load_tolls').value) || 0;
        const split = parseFloat(document.getElementById('r_split').value) || 0.8;
        const fuelN = parseFloat(document.getElementById('f_net').value) || 3.25;
        const mpg = parseFloat(document.getElementById('mpg').value) || 6.5;
        const mRate = parseFloat(document.getElementById('m_rate').value) || 0.17;
        
        const fixedTotal = (parseFloat(document.getElementById('f_truck').value) || 0) + 
                           (parseFloat(document.getElementById('f_trailer').value) || 0) + 
                           (parseFloat(document.getElementById('f_ins').value) || 0) +
                           (parseFloat(document.getElementById('f_advance').value) || 0) +
                           (parseFloat(document.getElementById('f_food').value) || 0) +
                           (parseFloat(document.getElementById('f_repairs').value) || 0);

        const totalMiles = loaded + dh;
        const fuelCost = (totalMiles / mpg) * fuelN;
        const maintCost = totalMiles * mRate;
        const profit = (gross * split) - fuelCost - maintCost - (fixedTotal / 5) - tolls;

        updateDashboard(
            loads.reduce((s,l) => s + l.gross, 0) + gross,
            loads.reduce((s,l) => s + l.miles, 0) + totalMiles,
            loads.reduce((s,l) => s + l.profit, 0) + profit
        );

        return { profit, totalMiles, fuelCost, maintCost, tolls, gross, fixed: (fixedTotal/5), splitVal: (gross * split), rpm: (totalMiles > 0 ? gross / totalMiles : 0) };
    }

    function updateDashboard(tg, tm, tp) {
        document.getElementById('week_gross').innerText = money(tg);
        document.getElementById('week_miles').innerText = tm.toLocaleString();
        document.getElementById('week_profit').innerText = money(tp);
        document.getElementById('week_rpm').innerText = money(tm > 0 ? tg / tm : 0);
        
        // Analytics
        document.getElementById('ann_gross').innerText = money(tg);
        document.getElementById('ann_profit').innerText = money(tp);
        document.getElementById('ann_tax').innerText = money(tp * 0.27);
        document.getElementById('oer_val').innerText = tg > 0 ? Math.round(((tg-tp)/tg)*100) + '%' : '0%';
    }

    function addLoad() {
        const res = manualCalc();
        loads.push({
            route: `${document.getElementById('origin').value} ‚á¢ ${document.getElementById('dest').value}`,
            miles: res.totalMiles, gross: res.gross, profit: res.profit, fuel: res.fuelCost,
            maint: res.maintCost, tolls: res.tolls, fixed: res.fixed, cut: res.splitVal, rpm: res.rpm
        });
        lastDrop = document.getElementById('dest').value;
        localStorage.setItem('last_drop_v9', lastDrop);
        saveAndRender();
        ['origin', 'dest', 'gross', 'load_tolls'].forEach(i => document.getElementById(i).value = i.includes('gross') ? 0 : "");
    }

    function saveAndRender() {
        localStorage.setItem('tag_v9_data', JSON.stringify(loads));
        document.getElementById('loadList').innerHTML = loads.map((l, i) => `
            <tr>
                <td>${l.route}</td><td>${l.miles}</td><td>$${l.gross}</td>
                <td class="${l.profit >= 0 ? 'pos' : 'neg'}">${money(l.profit)}</td>
                <td><span class="badge-view" onclick="viewDetails(${i})">View Detail</span></td>
                <td><button onclick="removeLoad(${i})" style="color:var(--danger); background:none; border:none; cursor:pointer">‚úï</button></td>
            </tr>
        `).join('');
        manualCalc();
    }

    function viewDetails(i) {
        const l = loads[i];
        document.getElementById('modal-content').innerHTML = `
            <div class="breakdown-row"><span>Load Gross:</span><span>${money(l.gross)}</span></div>
            <div class="breakdown-row"><span>Rate Per Mile:</span><span>${money(l.rpm)}</span></div>
            <div class="breakdown-row"><span>Your Split Cut:</span><span class="pos">${money(l.cut)}</span></div>
            <div class="breakdown-row"><span>Fuel Expense:</span><span class="neg">-${money(l.fuel)}</span></div>
            <div class="breakdown-row"><span>Tolls/Fees:</span><span class="neg">-${money(l.tolls)}</span></div>
            <div class="breakdown-row"><span>Maintenance Saved:</span><span class="neg">-${money(l.maint)}</span></div>
            <div class="breakdown-row"><span>Fixed Costs (1/5th):</span><span class="neg">-${money(l.fixed)}</span></div>
            <div class="breakdown-row total"><span>Net Trip Profit:</span><span class="${l.profit >= 0 ? 'pos' : 'neg'}">${money(l.profit)}</span></div>
        `;
        document.getElementById('modal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }
    function removeLoad(i) { loads.splice(i,1); saveAndRender(); }
    function hardReset() { if(confirm("Wipe all data?")) { localStorage.clear(); location.reload(); } }
    function money(v) { return '$' + Number(v).toLocaleString(undefined, {minimumFractionDigits: 2}); }

    document.getElementById('date-display').innerText = new Date().toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    saveAndRender();
</script>
</body>
</html>
